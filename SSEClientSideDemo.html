<!DOCTYPE html>
<html>
  <head>
    <title>Reactive Stock Dashboard</title>
    <meta charset="utf-8" />
    <script src="react/react.js"></script>
    <script src="react/react-dom.js"></script>
    <script src="react/babel.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
  </head>
  <body>
    <div id="app"></div>
    <script type="text/babel">

      const { useState, useEffect } = React;

      // Fixed-length queue for price history
      class FixedQueue {
          constructor(size) {
              this.size = size;
              this.queue = [];
          }
          push(item) {
              this.queue.push(item);
              if (this.queue.length > this.size) this.queue.shift();
          }
          getItems() {
              return this.queue;
          }
      }

      // Draw sparkline with D3
      function drawSparkline(id, data) {
          const container = document.getElementById(id);
          if (!container) return;
          container.innerHTML = ""; // Clear old sparkline

          const width = 100;
          const height = 30;

          const svg = d3.select(container)
                        .append("svg")
                        .attr("width", width)
                        .attr("height", height);

          const x = d3.scaleLinear()
                      .domain([0, data.length - 1])
                      .range([0, width]);

          const y = d3.scaleLinear()
                      .domain([d3.min(data), d3.max(data)])
                      .range([height, 0]);

          const line = d3.line()
                         .x((d, i) => x(i))
                         .y(d => y(d));

          svg.append("path")
             .datum(data)
             .attr("fill", "none")
             .attr("stroke", "steelblue")
             .attr("stroke-width", 1.5)
             .attr("d", line);
      }

      function StockRow({ stock, sparklineId }) {
          useEffect(() => {
              drawSparkline(sparklineId, stock.history.getItems());
          }, [stock.lastPrice]); // redraw on price update

          return (
              <tr>
                  <td>{stock.ticker}</td>
                  <td>{stock.name}</td>
                  <td>{stock.lastPrice}</td>
                  <td>{stock.volume}</td>
                  <td><div id={sparklineId}></div></td>
              </tr>
          );
      }

      function App() {
          const stockList = ["IBM", "AMZN", "DOW", "NASDAQ"];

          const initialStocks = {};
          stockList.forEach(t => {
              initialStocks[t] = {
                  ticker: t,
                  name: "",
                  lastPrice: 0,
                  volume: 0,
                  history: new FixedQueue(500)
              };
          });

          const [stocks, setStocks] = useState(initialStocks);

          useEffect(() => {
              const eventSource = new EventSource('http://localhost:31415/stocks');

              eventSource.onmessage = (event) => {
                  const data = JSON.parse(event.data);
                  setStocks(prevStocks => {
                      const updated = { ...prevStocks };
                      updated[data.ticker] = {
                          ...updated[data.ticker],
                          name: data.name,
                          lastPrice: data.price,
                          volume: data.volume,
                          history: updated[data.ticker].history
                      };
                      updated[data.ticker].history.push(data.price);
                      return updated;
                  });
              };

              return () => eventSource.close();
          }, []);

          return (
              <div>
                  <h1>Stock Dashboard</h1>
                  <table border="1">
                      <thead>
                          <tr>
                              <th>Ticker</th>
                              <th>Name</th>
                              <th>Price</th>
                              <th>Volume</th>
                              <th>Sparkline</th>
                          </tr>
                      </thead>
                      <tbody>
                          {stockList.map(ticker => (
                              <StockRow key={ticker} stock={stocks[ticker]} sparklineId={`spark-${ticker}`} />
                          ))}
                      </tbody>
                  </table>
              </div>
          );
      }

      ReactDOM.render(<App />, document.getElementById('app'));

    </script>
  </body>
</html>

